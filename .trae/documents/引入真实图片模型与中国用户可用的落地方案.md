## 目标与KPI
- 可用性：成功生成率≥99.5%，P95生成时长≤7s，错误率≤0.5%
- 性能与成本：单图成本≤¥X，单实例并发≥50QPS（异步队列），带宽峰值可水平扩展
- 体验：移动端“即开即用”，无需注册（匿名会话令牌），照片库/拍照均可上传
- 合规：国内合规可访问（备案、内容安全、隐私合规），密钥与数据安全

## 架构升级
- 前端：保持React+Vite；新增“异步任务+进度”协议（SSE/WebSocket），保留Mock作为回退
- 后端（新增）：API Gateway（Node/Express 或 Cloudflare Workers/阿里云FC），职责：
  - 统一模型Provider接口：`ImageModelProvider.generate(input): Promise<{imageUrl, meta}>`
  - 任务编排：入队（Redis/RabbitMQ/云队列）、Worker消费、状态持久化（缓存/临时存储）
  - 文件上传：预签名URL（OSS/对象存储），返回`uploadUrl`与`fileUrl`
  - 进度推送：SSE（简单）或WebSocket（更灵活）
  - 回传：生成结果转存到OSS并返回CDN可访问URL
- 存储与CDN：
  - 原图与结果图存储：阿里云OSS/腾讯云COS（大陆加速域名）
  - CDN：阿里云CDN/腾讯云CDN，开启HTTPS与缓存控制
- Provider层：
  - Dream4.0（占位）：HTTP API封装、重试、超时、错误分类（配额、内容、网络）
  - Fallback：本地Mock、备用模型（如「通义万相」「百度文心·图像」「腾讯混元图像」）
- PromptBuilder：
  - 统一模板（风格/地点），组装为`prompt`+`negative_prompt`+参数（分辨率、步骤、CFG等）
  - 多模型适配映射（参数名差异、取值范围）

## 中国可访问性与合规
- 访问路径：全部资源与API走国内云（阿里/腾讯/华为），避免海外CDN阻断
- 备案与域名：申请ICP备案，独立`https`域名；静态资源与API域名分离（同地域）
- 内容安全：
  - 上传时走图片鉴黄/涉政审核（云内容安全API），命中即拒绝+友好提示
  - Prompt安全白名单/关键词过滤与脱敏（防越权）
- 隐私保护：
  - 图片默认短期存储（如24h自动清理），可显式删除
  - 不收集身份信息；匿名会话令牌（JWT，短期有效）；CSRF防护与CORS白名单
- 灰度与降级：
  - 失败或超时（>15s）自动切换Mock或备用模型，前端保持统一进度体验

## 体验与产品策略
- 上传兼容：HEIC/JPG/PNG/WebP；大图本地压缩与分片上传（移动网络友好）
- 异步生成：
  - `POST /tasks` → 返回`taskId`
  - 前端订阅`GET /tasks/:id/stream`（SSE）→ 收到进度与完成事件（含`imageUrl`）
  - 结果页支持再次生成（复用原图与选项）
- 并发与限流：
  - IP级/会话级速率限制与配额；模型侧配额用量监控
  - 高峰时排队提示与预计等待时间（用户预期管理）

## 安全与密钥管理
- 后端持有模型Key（永不下发到前端），通过环境变量与密钥管理服务（KMS）
- 请求签名与日志审计（只记录必要元数据，不含原图）
- 防滥用：上传大小限制、MIME校验、图像指纹（去重缓存）

## 观测与SLO
- 指标：成功率、时延（P50/P95）、失败类型（网络/配额/内容/超时）、成本/调用次数
- 链路日志：后端结构化日志+前端错误上报（Sentry/自建）
- 报警：失败率>阈值、超时率升高、Key配额不足

## 交付与流水线
- 环境：`dev`（Mock+小流量）/`prod`（真实模型）
- Actions：
  - CI：类型检查、构建、单测
  - CD：后端部署到云函数/容器（阿里云FC/ACK），前端部署到国内CDN
- 配置：环境变量区分模型与存储Key；Sealed Secrets或云端参数管理

## 迭代与A/B
- A/B对比：不同模型/参数的成片质量、时延与成本；自动选择最优Provider
- 缓存与复用：对同一原图+同一Prompt去重，命中直接返回历史结果
- 水印与品牌：结果图角标与活动落地页链接（支持分享）

## 风险与应对
- 海外模型网络不稳定：优先国内模型或代理通道；失败自动回退
- 成本不可控：设置配额、峰值限流、活动时段开关；必要时引入支付（微信/支付宝）
- 法规变化：内容安全策略与风控规则可热更新

## 需求变更最小化接入
- 保持现有前端流程不变，只将“点击生成”改为走后端任务接口
- Mock保留为后备通道；前端无需感知具体模型

如需，我将按此方案分阶段落地：先打通最小后端（对象存储+任务编排+单一模型Provider），完成端到端生成与国内访问；随后补上内容安全、限流与观测。