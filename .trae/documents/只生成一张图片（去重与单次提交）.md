## 现象研判
- 第二张通常来自“重复提交”而非即梦返回两张：前端在结果就绪后、或 SSE / 轮询状态变化时再次触发 `/api/generate`。服务器端当前未做请求去重，导致同一素材短时间内被提交两次。

## 改动目标
- 保证一次用户动作只产生一个任务；同一素材在短时间内重复调用时直接复用已有任务 ID，不再新建提交。前端无须改动即可生效。

## 服务端改动
1. 在 `server/index.js` 引入请求指纹与去重缓存：
   - 计算指纹键：`key = hash(prompt + '|' + finalImageUrl)`（使用简单字符串哈希，或 Node `crypto` 的 `createHash('sha1')`）。
   - `recentRequests` Map 保存 `{ id, ts }`。
2. 在 `/api/generate` 中：
   - 生成 `finalImageUrl` 后先查重；若存在且还在窗口内（例如 60 秒）且对应任务非失败，则直接 `res.json({ taskId: existing.id })`；不入队、不提交。
   - 若不存在或已过期/失败，则正常新建任务并写入 `recentRequests`。
3. 可选：支持显式“重新生成”标志
   - 前端传 `force: true` 时跳过去重，允许再次提交（默认不需要，后端也可统一忽略）。

## 验证与观测
- 日志增加：打印 `key`、命中去重与返回的任务 ID；观察手机端仅生成一张图片。
- 压测：连续点击两次“生成”，第二次应立即返回第一次的 `taskId`，不会再次消耗 API。

## 代码要点（将应用到 server/index.js）
- 添加：`const recentRequests = new Map()` 与 `hashKey(str)`。
- 修改 `/api/generate`：在入队前做查重与复用逻辑。

确认后我将实现上述去重逻辑，并给出完整补丁。